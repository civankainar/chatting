<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Chat Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <style>
    :root{ color-scheme: dark; }
    body{ margin:0; font-family: ui-sans-serif, system-ui, -apple-system; background:#0b0c11; color:#fff; }
    .layout{ display:grid; grid-template-columns: 320px 1fr; gap:0; height:100vh; }
    .sidebar{ border-right:1px solid rgba(255,255,255,.08); background:#0f1117; display:flex; flex-direction:column; }
    .top{ padding:14px; border-bottom:1px solid rgba(255,255,255,.08); display:flex; gap:8px; align-items:center; }
    .brand{ font-weight:700 }
    .list{ overflow:auto; }
    .item{ padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.06); cursor:pointer; }
    .item:hover{ background:#10131b; }
    .active{ background:#141827; }
    .content{ display:flex; flex-direction:column; }
    .header{ padding:14px; border-bottom:1px solid rgba(255,255,255,.08); display:flex; align-items:center; gap:8px; }
    .grow{ flex:1 }
    .btn{ background:#1b2233; border:1px solid rgba(255,255,255,.08); color:#fff; border-radius:10px; padding:8px 12px; cursor:pointer; }
    .btn:hover{ transform: translateY(-1px); }
    .msgs{ flex:1; overflow:auto; padding:14px; display:flex; flex-direction:column; gap:8px; }
    .m{ max-width:70%; padding:8px 10px; border-radius:12px; border:1px solid rgba(255,255,255,.08);}
    .m.client{ align-self:flex-start; background:#152036; }
    .m.admin{ align-self:flex-end; background:#1b1f2b; }
    .m img{ max-width:100%; border-radius:10px; display:block }
    .m audio{ width:100%; }
    .composer{ display:flex; gap:8px; padding:14px; border-top:1px solid rgba(255,255,255,.08); }
    .field{ flex:1; background:#0c0d13; border:1px solid rgba(255,255,255,.08); color:#fff; border-radius:10px; padding:10px; outline:none; }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="top">
        <div class="brand">Admin Panel</div>
        <input id="token" placeholder="Admin Token" class="field" style="padding:8px; font-size:12px">
        <button class="btn" id="connectBtn">Bağlan</button>
      </div>
      <div id="list" class="list"></div>
    </aside>
    <main class="content">
      <div class="header">
        <div id="title" class="grow">Seçili sohbet yok</div>
        <input type="file" id="imgUp" accept="image/*" style="display:none">
        <button class="btn" id="imgBtn">📷 Görsel</button>
        <button class="btn" id="recBtn">🎙 Ses</button>
        <button class="btn" id="delBtn">🗑 Sil</button>
      </div>
      <div id="msgs" class="msgs"></div>
      <div class="composer">
        <input id="msg" class="field" placeholder="Mesaj yaz...">
        <button id="send" class="btn">Gönder</button>
      </div>
    </main>
  </div>

<script>
const BASE = location.origin;
let ws = null;
let token = "";
let activeClient = null;
const listEl = document.getElementById("list");
const msgsEl = document.getElementById("msgs");
const titleEl = document.getElementById("title");
const sendBtn = document.getElementById("send");
const msgField = document.getElementById("msg");
const imgBtn = document.getElementById("imgBtn");
const imgUp = document.getElementById("imgUp");
const recBtn = document.getElementById("recBtn");
const delBtn = document.getElementById("delBtn");

document.getElementById("connectBtn").onclick = () => {
  token = document.getElementById("token").value.trim();
  if (!token) return alert("Token girin");
  ws = new WebSocket(`${BASE.replace("http","ws")}/?role=admin&token=${encodeURIComponent(token)}`);
  ws.onopen = () => {
    ws.send(JSON.stringify({ type:"admin:list" }));
  };
  ws.onmessage = (e) => {
    const msg = JSON.parse(e.data);
    if (msg.type === "admin:list") renderList(msg.data || []);
    if (msg.type === "admin:history" && msg.clientId === activeClient) renderHistory(msg.data || []);
    if (msg.type === "message") {
      // yeni gelen client mesajı
      if (msg.clientId === activeClient) pushMsg("client", msg.kind, msg.content, msg.ts);
      ws.send(JSON.stringify({ type:"admin:list" })); // listeyi tazele
    }
    if (msg.type === "admin:newMessageEcho" && msg.clientId === activeClient) {
      pushMsg("admin", msg.kind, msg.content, msg.ts);
    }
    if (msg.type === "admin:deleted") {
      if (msg.clientId === activeClient) {
        activeClient = null; titleEl.textContent = "Seçili sohbet yok"; msgsEl.innerHTML = "";
      }
      ws.send(JSON.stringify({ type:"admin:list" }));
    }
  };
};

function renderList(rows) {
  listEl.innerHTML = "";
  for (const r of rows) {
    const item = document.createElement("div");
    item.className = "item" + (r.id === activeClient ? " active" : "");
    const last = r.lastContent ? (" - " + String(r.lastContent).replace(/\n/g," ").slice(0,40)) : "";
    item.textContent = `${r.username || "Anon"} (${r.id.slice(0,8)})${last}`;
    item.onclick = () => {
      activeClient = r.id;
      titleEl.textContent = `${r.username || "Anon"} — ${r.id}`;
      [...listEl.children].forEach(c => c.classList.remove("active"));
      item.classList.add("active");
      msgsEl.innerHTML = "";
      ws.send(JSON.stringify({ type:"admin:history", clientId: activeClient }));
    };
    listEl.appendChild(item);
  }
}

function renderHistory(arr) {
  msgsEl.innerHTML = "";
  for (const m of arr) pushMsg(m.sender, m.type, m.content, m.ts);
  msgsEl.scrollTop = msgsEl.scrollHeight;
}

function pushMsg(sender, kind, content, ts) {
  const el = document.createElement("div");
  el.className = "m " + (sender === "admin" ? "admin":"client");
  if (kind === "text") el.textContent = content;
  if (kind === "image") {
    const img = document.createElement("img");
    img.src = content; el.appendChild(img);
  }
  if (kind === "audio") {
    const audio = document.createElement("audio");
    audio.controls = true; audio.src = content; el.appendChild(audio);
  }
  const small = document.createElement("div");
  small.style.opacity = .5; small.style.fontSize = "11px"; small.style.marginTop = "4px";
  small.textContent = new Date(ts || Date.now()).toLocaleString();
  el.appendChild(small);
  msgsEl.appendChild(el);
  msgsEl.scrollTop = msgsEl.scrollHeight;
}

sendBtn.onclick = () => {
  if (!activeClient) return alert("Önce bir sohbet seçin.");
  const text = msgField.value.trim(); if (!text) return;
  ws.send(JSON.stringify({ type:"admin:send", clientId: activeClient, payload:{ text, kind:"text" } }));
  msgField.value = "";
};
msgField.addEventListener("keydown", (e) => { if (e.key === "Enter") sendBtn.click(); });

imgBtn.onclick = () => imgUp.click();
imgUp.onchange = async () => {
  if (!activeClient || !imgUp.files[0]) return;
  const fd = new FormData();
  fd.append("file", imgUp.files[0]);
  fd.append("clientId", activeClient);
  fd.append("role", "admin");
  await fetch(`${BASE}/api/upload/image`, { method:"POST", body:fd });
  imgUp.value = "";
};

let rec = null, chunks = [];
recBtn.onclick = async () => {
  if (!activeClient) return alert("Önce bir sohbet seçin.");
  if (!rec) {
    const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
    rec = new MediaRecorder(stream);
    rec.ondataavailable = (e) => chunks.push(e.data);
    rec.onstop = async () => {
      const blob = new Blob(chunks, { type:"audio/webm" }); chunks = [];
      const file = new File([blob], "admin-voice.webm", { type:"audio/webm" });
      const fd = new FormData();
      fd.append("file", file);
      fd.append("clientId", activeClient);
      fd.append("role", "admin");
      await fetch(`${BASE}/api/upload/audio`, { method:"POST", body:fd });
    };
    rec.start(); recBtn.textContent = "⏹";
  } else {
    rec.stop(); rec = null; recBtn.textContent = "🎙";
  }
};

delBtn.onclick = async () => {
  if (!activeClient) return;
  if (!confirm("Bu sohbeti silmek istediğinize emin misiniz?")) return;
  await fetch(`${BASE}/api/client/${encodeURIComponent(activeClient)}?token=${encodeURIComponent(token)}`, { method:"DELETE" });
};
</script>
</body>
</html>
